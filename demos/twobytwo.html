<html>
  <head><script src="https://unpkg.com/pts/dist/pts.min.js"></script></head>

  <body style="font-family: sans-serif; margin: 0;">
    <div id="pt" style="width: 100%; height: 100%; margin: 30px auto 0;"></div>
    <div style="padding: 20px 0; font-family: sans-serif; font-size: 0.8em; color: #9ab; text-align: center;">
       Generated by <a href="https://ptsjs.org/demo/edit">Pts demo editor</a>. Learn more at <a href="https://ptsjs.org">https://ptsjs.org</a>.
     </div>

    <script>


window.demoDescription = "2x2 matrices.";

  function transpose_(A, B) {
    A[0][0] = B[0][0];
    A[0][1] = B[1][0];
    A[1][0] = B[0][1];
    A[1][1] = B[1][1];
    return A;
  };

  function decompose_(gfpk, M) {
    gfpk[0][0] = (M[0][0]+M[1][1])/2;
    gfpk[0][1] = (M[0][0]-M[1][1])/2;
    gfpk[1][0] = (M[0][1]+M[1][0])/2;
    gfpk[1][1] = (M[0][1]-M[1][0])/2;
    return gfpk
  };

  function compose_(M, gfpk) {
    g = gfpk[0][0];
    f = gfpk[0][1];
    p = gfpk[1][0];
    k = gfpk[1][1];

    M[0][0] = g+f;
    M[0][1] = p+k;
    M[1][0] = p-k;
    M[1][1] = g-f;
    return M;
  }

  function swap_(gkfp, gfpk) {
    gkfp[0][0] = gfpk[0][0];
    gkfp[0][1] = gfpk[1][1];
    gkfp[1][0] = gfpk[0][1];
    gkfp[1][1] = gfpk[1][0];

    return gkfp;
  }
  
  function unswap_(gfpk, gkfp) {
    gfpk[0][0] = gkfp[0][0];
    gfpk[0][1] = gkfp[1][0];
    gfpk[1][0] = gkfp[1][1];
    gfpk[1][1] = gkfp[0][1];

    return gfpk;
  }


  function eigs_(eigs, gfpk) {
    g = gfpk[0][0];
    f = gfpk[0][1];
    p = gfpk[1][0];
    k = gfpk[1][1];
    disc = k*k+p*p-f*f;
    if(disc>=0) {
      co = Math.sqrt(disc);
      im = 0;
    }else{
      co = 0;
      im = Math.sqrt(-disc);
    }
    eigs[0][0] = g + co;
    eigs[0][1] = im;
    eigs[1][0] = g - co;
    eigs[1][1] = -im;

    return eigs;
  }

  function eigvecs_(eigvecs, eigs, gfpk) {
    g = gfpk[0][0];
    f = gfpk[0][1];
    p = gfpk[1][0];
    k = gfpk[1][1];
    eigvecs[0][0] = eigs[0][0] + p - g;
    eigvecs[0][1] = eigs[0][1];
    eigvecs[1][0] = k-f;
    eigvecs[1][1] = 0;
    eigvecs[2][0] = eigs[1][0] + p - g;
    eigvecs[2][1] = eigs[1][1];
    eigvecs[3][0] = k-f;
    eigvecs[3][1] = 0;

    return eigvecs;

  }


(function() {

  Pts.quickStart( "#pt", "#42e" ); 

  var M0 = [new Pt(1,3), new Pt(4,5)];

  var M = [new Pt(0,0), new Pt(0,0)];
  var MT = [new Pt(0,0), new Pt(0,0)];
  var gfpk = [new Pt(0,0), new Pt(0,0)];
  var gkfp = [new Pt(0,0), new Pt(0,0)];
  var eigs = [new Pt(0,0), new Pt(0,0)];
  var eigvecs = [new Pt(0,0), new Pt(0,0), new Pt(0,0), new Pt(0,0)];

  var origin = new Pt(0,0);
  var origin2 = new Pt(0,0);
  var origin3 = new Pt(0,0);
  var origin4 = new Pt(0,0);
  var handles;
  var scale = 50;

  function fromPt(pt) {
    return pt.$subtract(origin).divide(new Pt(scale, -scale));
  };

  function toPt(pt) {
    return pt.multiply(new Pt(scale, -scale)).add(origin);
  };

  function apply(transform, to, fr) {
     transform(to, fr.map(fromPt)).map(toPt);
  };

  function toOrigin(pts,o) {
    return pts.map(u=>{u.subtract(origin).add(o)})
  }

  function apply_all(M) {
    apply(transpose_, MT, M);
    apply(decompose_, gfpk, M);
    apply(swap_, gkfp, gfpk);
    apply(eigs_, eigs, gfpk);
    eigvecs_(eigvecs, eigs.map(fromPt), gfpk.map(fromPt)).map(toPt);
    toOrigin(gfpk, origin2);
    toOrigin(gkfp, origin2);
    toOrigin(eigs, origin3);
    toOrigin(eigvecs, origin4);

  };

  function print(origin_, pt) {
    pt = fromPt(pt.$subtract(origin_).add(origin));
    return "(" + pt[0].toFixed(1) + ", " + pt[1].toFixed(1) + ")";
  };

  function make_dragger(fn) {
      function make(h) {
        let ud = UIDragger.fromCircle( [h, [10,10]] );
        
        ud.onDrag( (ui, pt) => { // drag handling
          ui.group[0].to( space.pointer.$subtract( ui.state('offset') ) );
          fn();
          apply_all(M);
        });

        ud.onHover( // hover handling
          (ui) => ui.group[1].scale(1.5),
          (ui) => ui.group[1].scale(1/1.5),
        )
        return ud;
      }
      return make;
  }

  space.add( {

    start: (bound, space) => {      
      origin = space.center.$add(-space.width/4, -space.height/4);
      origin2 = space.center.$add(space.width/4, -space.height/4);
      origin3 = space.center.$add(-space.width/4, space.height/4);
      origin4 = space.center.$add(space.width/4, space.height/4);

      MT = M0.map(toPt);
      apply(transpose_, M, MT);
      apply_all(M);

      handles = M.map(make_dragger(()=>{}));
      handles = handles.concat(MT.map(make_dragger(()=>{
          apply(transpose_, M, MT)})));
      handles = handles.concat(gfpk.map(make_dragger(()=>{
          apply(compose_, M, gfpk.map(u=>{return u.$subtract(origin2).add(origin)}))})));
      handles = handles.concat(gkfp.map(make_dragger((u)=>{
          apply(unswap_, gfpk, gkfp.map(u=>{return u.$subtract(origin2).add(origin)})); 
          apply(compose_, M, gfpk);})));
      handles = handles.concat(eigs.map(make_dragger((u)=>{
        //   todo(bchasnov): add mapping from eig to M (projection)
        })));      
      handles = handles.concat(eigvecs.map(make_dragger((u)=>{
        //   todo(bchasnov): add mapping from eig to M (projection)
        })));
    },   

    animate: (time, ftime) => {  
      // Circles    
      form.strokeOnly("#999").circle(Circle.fromRect([MT[0], M[0], M[0], MT[0]], 100));     
      form.strokeOnly("#999").circle(Circle.fromRect([MT[1], M[1], M[1], MT[1]], 100));     

      // Rows of M
      form.strokeOnly("#999", 2).line([MT[0], origin]);
      form.strokeOnly("#999", 2).line([MT[1], origin]);

      // Columns of M
      form.strokeOnly("#fff", 2).line([M[0], origin]);
      form.strokeOnly("#fff", 2).line([M[1], origin]);

      form.strokeOnly("#999", 2).line([gkfp[0].$subtract(0, 1000), gkfp[0].$add(0, space.width/4)])
      form.circle(Circle.fromCenter(origin2, gkfp[1].$subtract(origin2).magnitude()));

      



      // Origins
      form.fillOnly("#000");
      form.circle(Circle.fromCenter(origin, 3));
      form.circle(Circle.fromCenter(origin2, 3));
      form.circle(Circle.fromCenter(origin3, 3));
      form.circle(Circle.fromCenter(origin4, 3));


      // GUI handles
      form.fillOnly("#009");
      handles.forEach( h => h.render( g => form.circle(g) ) );

      // Text
      form.fillOnly("#fff");
      form.text(M[0].$add(-100, 0), "col1="+print(origin, M[0]));
      form.text(M[1].$add(0, -10), "col2="+print(origin, M[1]));
      form.text(MT[0], "row1="+print(origin, MT[0]));
      form.text(MT[1].$add(0,10), "row2="+print(origin, MT[1]));

      form.text(gfpk[0].$add(0, 10), "gf="+print(origin2, gfpk[0]));
      form.text(gfpk[1].$add(0, 10), "pk="+print(origin2, gfpk[1]));
      form.text(gkfp[0].$add(0, -10), "gk="+print(origin2, gkfp[0]));
      form.text(gkfp[1].$add(0, -10), "fp="+print(origin2, gkfp[1]));
      
      form.text(eigs[0].$add(0, 10), "z="+print(origin3, eigs[0]));
      form.text(eigs[1].$add(0, -10), "z="+print(origin3, eigs[1]));

      // Debug
    //   form.circle.fromCenter(new Pt(MT[0][0], (MT[0][1]+M[0][1])/2), MT[0][1]-M[0][1]);
    //   form.text(origin.$subtract(scale*3,10), "rows=" + print(origin, MT[0]));
    //   form.text(origin.$subtract(scale*3,-10),"          " +  print(origin, MT[1]));
    //   _M0 = toCoords(origin, M[0]);
    //   _M1 = toCoords(origin, M[1]);
    //   form.text(origin.$subtract(scale*3,100), "  M=" + _M0[0].toFixed(2) + "   " + _M1[0].toFixed(2));
    //   form.text(origin.$subtract(scale*3,80), "  " + _M0[1].toFixed(2) + "   " + _M1[1].toFixed(2));
    //   _M0 = toCoords(origin, MT[0]);
    //   _M1 = toCoords(origin, MT[1]);
    //   form.text(origin.$subtract(scale*3,60), "MT=" + _M0[0].toFixed(2) + "   " + _M1[0].toFixed(2));
    //   form.text(origin.$subtract(scale*3,40), "    " + _M0[1].toFixed(2) + "   " + _M1[1].toFixed(2));
    //   form.text(origin.$subtract(scale*3, -40), "g,f=" + print(origin, gfpk[0]));
    //   form.text(origin.$subtract(scale*3, -60), "p,k=" + print(origin, gfpk[1]));
    },

    action:( type, px, py) => {
      UI.track( handles, type, new Pt(px, py) );
    },
    
    resize:( bound, evt) => {
      if (form.ready) {

      }
    }
  });
    
  //// ----
  space.bindMouse().bindTouch().play();

})();


    </script>
  </body>
</html>
